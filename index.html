<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ†å¸³å·¥å…·-iPhoneç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f2f2f7; padding: 20px; margin: 0; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; background: #007aff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; margin-top: 10px; }
        li { background: #fff; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .total { font-size: 20px; font-weight: bold; text-align: center; margin: 20px 0; color: #1c1c1e; }
        .delete-hint { font-size: 12px; color: #8e8e93; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>

<div class="card">
    <h3 style="margin-top:0">ğŸ’° å¤šäººåˆ†å¸³</h3>
    <input type="text" id="payer" placeholder="ä»˜æ¬¾äºº" autocomplete="off">
    <input type="number" id="amount" placeholder="é‡‘é¡" inputmode="decimal">
    <input type="text" id="description" placeholder="é …ç›®å…§å®¹" autocomplete="off">
    <button onclick="addExpense()">æ–°å¢ç´€éŒ„</button>
</div>

<div class="total" id="totalDisplay">ç¸½è¨ˆ: $0</div>
<div class="delete-hint">æç¤ºï¼šé»æ“Šé …ç›®å³å¯åˆªé™¤</div>
<div id="expenseList" style="margin-top: 10px; border-radius: 12px; overflow: hidden;"></div>

<script>
    const SUPABASE_URL = 'https://kwrefnmhjuwnvfipxdyq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3cmVmbm1oanV3bnZmaXB4ZHlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyOTQ4NTksImV4cCI6MjA4Njg3MDg1OX0.jthw2efO6SSzIm0PpY0scQ9cBrAtByEzxxrzz1YOHlc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function fetchExpenses() {
        const { data, error } = await supabaseClient.from('expenses').select('*').order('created_at', { ascending: false });
        if (!error) render(data);
    }

    function render(data) {
        const list = document.getElementById('expenseList');
        let total = 0;
        list.innerHTML = data.map(item => {
            total += Number(item.amount);
            return `<div class="li" onclick="deleteItem(${item.id}, '${item.description}')">
                <div style="padding:15px; background:white; border-bottom:1px solid #eee; display:flex; justify-content:space-between">
                    <span><b>${item.payer}</b>: ${item.description}</span>
                    <span style="color:#ff3b30; font-weight:bold">$${item.amount}</span>
                </div>
            </div>`;
        }).join('');
        document.getElementById('totalDisplay').innerText = `ç¸½è¨ˆ: $${total}`;
    }

    async function addExpense() {
        const payer = document.getElementById('payer').value;
        const amount = document.getElementById('amount').value;
        const description = document.getElementById('description').value;
        if(!payer || !amount) return alert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');

        const { error } = await supabaseClient.from('expenses').insert([{ payer, amount, description }]);
        if (error) alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ SQL æ˜¯å¦å·²åŸ·è¡Œ');
        else {
            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            fetchExpenses();
        }
    }

    async function deleteItem(id, name) {
        if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ`)) {
            await supabaseClient.from('expenses').delete().eq('id', id);
            fetchExpenses();
        }
    }

    // é–‹å•Ÿå³æ™‚æ›´æ–°
    supabaseClient.channel('custom-all-channel')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'expenses' }, () => fetchExpenses())
    .subscribe();

    fetchExpenses();
</script>

</body>
</html>
