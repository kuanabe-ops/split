<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ˆæ¥­å¤šäººåˆ†å¸³ç³»çµ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        body { background-color: #f2f2f7; -webkit-tap-highlight-color: transparent; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        input[type="number"]::-webkit-inner-spin-button { display: none; }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-xl relative flex flex-col">

    <div v-if="!projectId" class="p-8 flex flex-col justify-center flex-1">
        <h1 class="text-4xl font-black text-center mb-2 text-blue-600">åˆ†å¸³ç¥å™¨</h1>
        <p class="text-center text-gray-400 mb-8">ç®¡ç†å°ˆæ¡ˆã€æˆå“¡èˆ‡è¤‡é›œå¸³å‹™</p>
        <div class="space-y-4">
            <input v-model="newProjectName" type="text" placeholder="è¼¸å…¥å°ˆæ¡ˆåç¨± (å¦‚: æ±äº¬ä¹‹æ—…)" class="w-full p-4 border rounded-xl bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
            <button @click="createProject" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition">å»ºç«‹æ–°å°ˆæ¡ˆ</button>
        </div>
    </div>

    <div v-else class="flex flex-col flex-1">
        <header class="bg-blue-600 text-white p-4 sticky top-0 z-30">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-xl">{{ projectName }}</h2>
                    <p class="text-xs opacity-70" @click="copyLink">é»æ­¤è¤‡è£½ç¶²å€åˆ†äº«çµ¦æˆå“¡ ğŸ”—</p>
                </div>
                <button @click="currentView = 'settle'" class="bg-white/20 px-4 py-2 rounded-lg font-bold text-sm backdrop-blur-md">çµç®—çµæœ</button>
            </div>
        </header>

        <nav class="flex border-b bg-white sticky top-[68px] z-20">
            <button @click="currentView = 'list'" :class="currentView === 'list' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-400'" class="flex-1 py-4 font-bold transition">å¸³å‹™æ¸…å–®</button>
            <button @click="currentView = 'members'" :class="currentView === 'members' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-400'" class="flex-1 py-4 font-bold transition">æˆå“¡ç®¡ç†</button>
        </nav>

        <main v-if="currentView === 'list'" class="p-4 space-y-3 flex-1">
            <div v-if="expenses.length === 0" class="py-20 text-center text-gray-300">
                ç›®å‰å°šç„¡ç´€éŒ„<br>è«‹é»æ“Šå³ä¸‹è§’æŒ‰éˆ•æ–°å¢
            </div>
            <div v-for="exp in expenses" :key="exp.id" class="bg-white border p-4 rounded-xl shadow-sm">
                <div class="flex justify-between items-start">
                    <h4 class="font-bold text-gray-800 text-lg">{{ exp.title }}</h4>
                    <span class="text-blue-600 font-black text-xl">${{ exp.amount }}</span>
                </div>
                <div class="flex justify-between items-end mt-2">
                    <div class="text-xs text-gray-500">
                        <div>ğŸ•’ {{ exp.date }}</div>
                        <div>ğŸ‘¤ ä»˜æ¬¾äºº: {{ getPayerDisplay(exp.payers) }}</div>
                    </div>
                    <button @click="deleteExpense(exp.id)" class="text-red-400 text-xs">åˆªé™¤</button>
                </div>
            </div>
            <div class="h-24"></div>
        </main>

        <main v-if="currentView === 'members'" class="p-4 space-y-4">
            <div class="grid grid-cols-2 gap-2">
                <div v-for="m in members" :key="m.id" class="bg-gray-100 p-3 rounded-lg flex justify-between">
                    <span class="font-bold">{{ m.name }}</span>
                </div>
            </div>
            <div class="flex gap-2">
                <input v-model="newMemberName" type="text" placeholder="æ–°æˆå“¡å§“å" class="flex-1 p-3 border rounded-lg outline-none">
                <button @click="addMember" class="bg-green-500 text-white px-6 rounded-lg font-bold">åŠ å…¥</button>
            </div>
        </main>

        <div v-if="currentView === 'settle'" class="fixed inset-0 bg-white z-50 p-6 overflow-y-auto">
            <button @click="currentView = 'list'" class="text-blue-600 font-bold mb-6">âœ• é—œé–‰çµç®—</button>
            <h2 class="text-3xl font-black mb-6">çµç®—å ±å‘Š</h2>
            
            <section class="mb-8">
                <h3 class="text-gray-400 font-bold mb-3 uppercase tracking-widest text-sm">å€‹äººæ”¯å‡ºçµ±è¨ˆ</h3>
                <div class="space-y-2">
                    <div v-for="s in settlement.balances" class="flex justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-bold">{{ s.name }}</span>
                        <span :class="s.amount >= 0 ? 'text-green-600' : 'text-red-500'" class="font-mono font-bold">
                            {{ s.amount >= 0 ? 'æ‡‰æ”¶' : 'æ‡‰ä»˜' }} ${{ Math.abs(Math.round(s.amount)) }}
                        </span>
                    </div>
                </div>
            </section>

            <section>
                <h3 class="text-gray-400 font-bold mb-3 uppercase tracking-widest text-sm">å»ºè­°è½‰å¸³æ–¹æ¡ˆ</h3>
                <div v-if="settlement.transfers.length === 0" class="text-center py-10 text-gray-300">ç›®å‰å¸³å‹™å¹³è¡¡ï¼Œä¸éœ€è½‰å¸³</div>
                <div v-for="t in settlement.transfers" class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-3 flex items-center justify-between">
                    <span><b>{{ t.from }}</b> è½‰çµ¦ <b>{{ t.to }}</b></span>
                    <span class="text-blue-600 font-black text-xl">${{ Math.round(t.amount) }}</span>
                </div>
            </section>
        </div>

        <button v-if="currentView === 'list'" @click="openModal" class="fixed bottom-8 right-8 w-16 h-16 bg-blue-600 text-white rounded-full shadow-2xl text-3xl font-bold active:scale-90 transition-transform z-40">+</button>

        <div v-if="isModalOpen" class="fixed inset-0 bg-black/60 z-[60] flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl flex flex-col max-h-[90vh]">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <span class="font-black text-lg">æ–°å¢å¸³å‹™</span>
                    <button @click="isModalOpen = false" class="text-2xl text-gray-400">&times;</button>
                </div>

                <div class="p-5 overflow-y-auto space-y-4">
                    <input v-model="form.title" type="text" placeholder="é …ç›®åç¨± (å¦‚: æ™šé¤)" class="w-full p-3 border rounded-xl bg-gray-50 outline-none">
                    <div class="flex gap-2">
                        <input v-model.number="form.amount" type="number" placeholder="é‡‘é¡" class="flex-1 p-3 border rounded-xl bg-gray-50 outline-none">
                        <input v-model="form.date" type="date" class="w-1/3 p-3 border rounded-xl bg-gray-50 text-sm outline-none">
                    </div>

                    <div class="p-4 border rounded-xl space-y-3">
                        <div class="flex justify-between items-center">
                            <label class="font-bold text-sm">èª°ä»˜æ¬¾çš„ï¼Ÿ</label>
                            <div class="bg-gray-200 p-1 rounded-lg flex text-xs font-bold cursor-pointer">
                                <div @click="form.pMode='single'" :class="form.pMode==='single'?'bg-white shadow text-blue-600':''" class="px-3 py-1 rounded-md transition">å–®äºº</div>
                                <div @click="form.pMode='multi'" :class="form.pMode==='multi'?'bg-white shadow text-blue-600':''" class="px-3 py-1 rounded-md transition">æ‰‹å‹•</div>
                            </div>
                        </div>
                        <select v-if="form.pMode==='single'" v-model="form.singleP" class="w-full p-2 border rounded-lg">
                            <option v-for="m in members" :value="m.id">{{ m.name }}</option>
                        </select>
                        <div v-else class="space-y-2">
                            <div v-for="m in members" class="flex justify-between items-center">
                                <span class="text-sm">{{ m.name }}</span>
                                <input v-model.number="form.multiP[m.id]" type="number" placeholder="0" class="w-24 p-2 border rounded text-right">
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border rounded-xl space-y-3">
                        <div class="flex justify-between items-center">
                            <label class="font-bold text-sm">å¦‚ä½•åˆ†å¸³ï¼Ÿ</label>
                            <div class="bg-gray-200 p-1 rounded-lg flex text-xs font-bold cursor-pointer">
                                <div @click="form.sMode='equal'" :class="form.sMode==='equal'?'bg-white shadow text-blue-600':''" class="px-3 py-1 rounded-md transition">å¹³å‡</div>
                                <div @click="form.sMode='manual'" :class="form.sMode==='manual'?'bg-white shadow text-blue-600':''" class="px-3 py-1 rounded-md transition">æ‰‹å‹•</div>
                            </div>
                        </div>
                        <div v-if="form.sMode==='equal'" class="flex flex-wrap gap-2">
                            <div v-for="m in members" @click="toggleSplit(m.id)" :class="form.sList.includes(m.id)?'bg-blue-600 text-white':'bg-gray-100 text-gray-400'" class="px-4 py-2 rounded-full text-xs font-bold transition">
                                {{ m.name }}
                            </div>
                        </div>
                        <div v-else class="space-y-2">
                            <div v-for="m in members" class="flex justify-between items-center">
                                <span class="text-sm">{{ m.name }}</span>
                                <input v-model.number="form.manualS[m.id]" type="number" placeholder="0" class="w-24 p-2 border rounded text-right">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-5 safe-area-bottom">
                    <button @click="save" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition">å®Œæˆè¨˜å¸³</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- å·²å¹«ä½ å¡«å¥½ä½ çš„å°ˆæ¡ˆè³‡è¨Š ---
    const SB_URL = 'https://kwrefnmhjuwnvfipxdyq.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3cmVmbm1oanV3bnZmaXB4ZHlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyOTQ4NTksImV4cCI6MjA4Njg3MDg1OX0.jthw2efO6SSzIm0PpY0scQ9cBrAtByEzxxrzz1YOHlc';
    const client = supabase.createClient(SB_URL, SB_KEY);

    const { createApp, ref, onMounted, computed } = Vue;

    createApp({
        setup() {
            const projectId = ref(null);
            const projectName = ref('');
            const newProjectName = ref('');
            const members = ref([]);
            const expenses = ref([]);
            const currentView = ref('list');
            const isModalOpen = ref(false);
            const newMemberName = ref('');

            const form = ref({
                title: '', amount: '', date: '', pMode: 'single', singleP: '', multiP: {}, sMode: 'equal', sList: [], manualS: {}
            });

            onMounted(() => {
                const pid = new URLSearchParams(window.location.search).get('project_id');
                if(pid) {
                    projectId.value = pid;
                    init();
                    listen();
                }
            });

            async function init() {
                const { data: p } = await client.from('projects').select('*').eq('id', projectId.value).single();
                if(p) projectName.value = p.name;
                const { data: m } = await client.from('members').select('*').eq('project_id', projectId.value);
                members.value = m || [];
                refresh();
            }

            async function refresh() {
                const { data } = await client.from('expenses').select('*').eq('project_id', projectId.value).order('created_at', {ascending: false});
                expenses.value = data || [];
            }

            function listen() {
                client.channel('any').on('postgres_changes', {event:'*', schema:'public'}, () => {
                    init();
                }).subscribe();
            }

            async function createProject() {
                if(!newProjectName.value) return;
                const { data } = await client.from('projects').insert({name: newProjectName.value}).select().single();
                window.location.search = `?project_id=${data.id}`;
            }

            async function addMember() {
                if(!newMemberName.value) return;
                await client.from('members').insert({project_id: projectId.value, name: newMemberName.value});
                newMemberName.value = '';
            }

            function openModal() {
                if(members.value.length === 0) return alert('è«‹å…ˆåŠ å…¥æˆå“¡');
                form.value = {
                    title: '', amount: '', date: new Date().toISOString().split('T')[0],
                    pMode: 'single', singleP: members.value[0].id, multiP: {},
                    sMode: 'equal', sList: members.value.map(m=>m.id), manualS: {}
                };
                isModalOpen.value = true;
            }

            function toggleSplit(id) {
                const idx = form.value.sList.indexOf(id);
                idx > -1 ? form.value.sList.splice(idx, 1) : form.value.sList.push(id);
            }

            async function save() {
                const f = form.value;
                if(!f.title || !f.amount) return alert('è«‹å¡«å¯«å®Œæ•´');
                
                let payObj = {};
                if(f.pMode === 'single') payObj[f.singleP] = f.amount;
                else payObj = f.multiP;

                let splitObj = {};
                if(f.sMode === 'equal') {
                    const avg = f.amount / f.sList.length;
                    f.sList.forEach(id => splitObj[id] = avg);
                } else splitObj = f.manualS;

                await client.from('expenses').insert({
                    project_id: projectId.value, title: f.title, amount: f.amount,
                    date: f.date, payers: payObj, split_details: splitObj
                });
                isModalOpen.value = false;
            }

            async function deleteExpense(id) {
                if(confirm('åˆªé™¤æ­¤ç­†å¸³å‹™ï¼Ÿ')) await client.from('expenses').delete().eq('id', id);
            }

            const settlement = computed(() => {
                const balances = {};
                members.value.forEach(m => balances[m.id] = 0);
                expenses.value.forEach(e => {
                    for(let id in e.payers) balances[id] = (balances[id] || 0) + Number(e.payers[id]);
                    for(let id in e.split_details) balances[id] = (balances[id] || 0) - Number(e.split_details[id]);
                });

                const sorted = members.value.map(m => ({name: m.name, amount: balances[m.id] || 0}))
                    .sort((a,b) => b.amount - a.amount);
                
                const transfers = [];
                let d = sorted.filter(x => x.amount < -0.1), c = sorted.filter(x => x.amount > 0.1);
                let i=0, j=0;
                while(i < d.length && j < c.length) {
                    let amt = Math.min(Math.abs(d[i].amount), c[j].amount);
                    transfers.push({from: d[i].name, to: c[j].name, amount: amt});
                    d[i].amount += amt; c[j].amount -= amt;
                    if(Math.abs(d[i].amount) < 0.1) i++;
                    if(c[j].amount < 0.1) j++;
                }
                return { balances: sorted, transfers };
            });

            function getPayerDisplay(p) {
                const ids = Object.keys(p);
                if(ids.length > 1) return 'å¤šäººåˆ†æ“”';
                return members.value.find(m => m.id == ids[0])?.name || 'æœªçŸ¥';
            }

            function copyLink() {
                navigator.clipboard.writeText(window.location.href);
                Toastify({text:"åˆ†äº«é€£çµå·²è¤‡è£½ï¼", duration:2000, gravity:"top", position:"center", style:{background:"#2563eb", borderRadius:"10px"}}).showToast();
            }

            return { projectId, projectName, newProjectName, members, expenses, currentView, isModalOpen, newMemberName, form, settlement, createProject, addMember, openModal, toggleSplit, save, deleteExpense, getPayerDisplay, copyLink };
        }
    }).mount('#app');
</script>
</body>
</html>
