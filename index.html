<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½å‹å¤šäººåˆ†å¸³å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #24b47e; --bg: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: #333; margin-bottom: 25px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9em; color: #666; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { background: #1f9d6d; opacity: 0.9; }
        
        .divider { height: 1px; background: #eee; margin: 30px 0; position: relative; }
        .divider::after { content: "æ”¶æ”¯æ˜ç´°"; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 15px; color: #999; font-size: 0.8em; }

        .summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 15px; background: #eefaf5; border-radius: 10px; }
        .total-label { color: #555; }
        .total-amount { font-size: 1.5em; font-weight: bold; color: var(--primary); }

        ul { list-style: none; padding: 0; }
        li { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        li:last-child { border-bottom: none; }
        .item-info { display: flex; flex-direction: column; }
        .item-payer { font-weight: bold; color: #333; }
        .item-desc { font-size: 0.85em; color: #888; margin-top: 2px; }
        .item-price { font-weight: bold; color: #e67e22; }
        
        .empty-state { text-align: center; color: #ccc; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ’° å¤šäººå³æ™‚åˆ†å¸³</h2>
    
    <div class="form-group">
        <label>èª°ä»˜çš„éŒ¢ï¼Ÿ</label>
        <input type="text" id="payer" placeholder="ä¾‹å¦‚ï¼šå°æ˜">
    </div>
    <div class="form-group">
        <label>å¤šå°‘éŒ¢ï¼Ÿ</label>
        <input type="number" id="amount" placeholder="ä¾‹å¦‚ï¼š1200">
    </div>
    <div class="form-group">
        <label>é …ç›®èªªæ˜</label>
        <input type="text" id="description" placeholder="ä¾‹å¦‚ï¼šé¼æ³°è±åˆé¤">
    </div>
    <button onclick="addExpense()">ç¢ºèªæ–°å¢</button>

    <div class="divider"></div>

    <div class="summary">
        <span class="total-label">ç¸½è¨ˆæ”¯å‡º</span>
        <span class="total-amount" id="totalDisplay">$0</span>
    </div>

    <ul id="expenseList">
        <div class="empty-state">ç›®å‰é‚„æ²’æœ‰è³‡æ–™...</div>
    </ul>
</div>

<script>
    // --- 1. Supabase è¨­å®š (å·²å¡«å…¥ä½ çš„è³‡è¨Š) ---
    const SUPABASE_URL = 'https://kwrefnmhjuwnvfipxdyq.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3cmVmbm1oanV3bnZmaXB4ZHlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyOTQ4NTksImV4cCI6MjA4Njg3MDg1OX0.jthw2efO6SSzIm0PpY0scQ9cBrAtByEzxxrzz1YOHlc';
    
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const expenseList = document.getElementById('expenseList');
    const totalDisplay = document.getElementById('totalDisplay');

    // --- 2. ç²å–è³‡æ–™å‡½æ•¸ ---
    async function fetchExpenses() {
        let { data: expenses, error } = await supabaseClient
            .from('expenses')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            console.error('è®€å–å¤±æ•—:', error);
            return;
        }
        render(expenses);
    }

    // --- 3. æ¸²æŸ“ç•«é¢ ---
    function render(expenses) {
        if (expenses.length === 0) {
            expenseList.innerHTML = '<div class="empty-state">ç›®å‰é‚„æ²’æœ‰è³‡æ–™...</div>';
            totalDisplay.innerText = '$0';
            return;
        }

        expenseList.innerHTML = '';
        let total = 0;
        expenses.forEach(item => {
            total += parseFloat(item.amount || 0);
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="item-info">
                    <span class="item-payer">${item.payer}</span>
                    <span class="item-desc">${item.description || 'æœªåˆ†é¡'}</span>
                </div>
                <span class="item-price">$${item.amount}</span>
            `;
            expenseList.appendChild(li);
        });
        totalDisplay.innerText = `$${total.toLocaleString()}`;
    }

    // --- 4. æ–°å¢è³‡æ–™åˆ°è³‡æ–™åº« ---
    async function addExpense() {
        const payer = document.getElementById('payer').value.trim();
        const amount = document.getElementById('amount').value;
        const description = document.getElementById('description').value.trim();

        if (!payer || !amount) {
            alert('è«‹è¼¸å…¥å§“åèˆ‡é‡‘é¡ï¼');
            return;
        }

        const { error } = await supabaseClient
            .from('expenses')
            .insert([{ 
                payer: payer, 
                amount: parseFloat(amount), 
                description: description 
            }]);

        if (error) {
            alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™è¡¨åç¨±æ˜¯å¦ç‚º expenses ä¸” RLS å·²é—œé–‰');
            console.error(error);
        } else {
            // æ¸…ç©ºè¼¸å…¥æ¬„ä½
            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            // ç”±æ–¼æœ‰ Realtime ç›£è½ï¼Œé€™è£¡å…¶å¯¦å¯ä»¥ä¸ç”¨æ‰‹å‹• fetchï¼Œä½†æ‰‹å‹• fetch æœƒåæ‡‰æ›´å¿«
            fetchExpenses();
        }
    }

    // --- 5. é–‹å•Ÿå³æ™‚æ›´æ–° (Realtime) ---
    // é€™èƒ½è®“å…¶ä»–äººçš„ç¶²é è‡ªå‹•è·³å‡ºæ–°è³‡æ–™
    supabaseClient
        .channel('any')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'expenses' }, payload => {
            console.log('åµæ¸¬åˆ°è®Šå‹•:', payload);
            fetchExpenses();
        })
        .subscribe();

    // åˆå§‹åŒ–è®€å–
    fetchExpenses();
</script>

</body>
</html>
